name: Shadow scans
on:
  schedule:
    # Run the workflow every day at 04:00 UTC
    - cron: '0 4 * * *'

jobs:
  scan:
    runs-on: github-ubuntu-latest-m
    name: Scan on shadow platforms
    permissions:
      id-token: write
      contents: write
    env:
      IDE_CACHE_DIR: /opt/jetbrains
      INTELLIJ_VERSION: "2023.1.7"
      CLION_VERSION: "2023.1.7"
      RIDER_VERSION: "2023.1.7"
      RESHARPER_VERSION: "2024.1"
      ULTIMATE_VERSION: "2023.1.7"
    steps:
      - name: Vault
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/SonarSource-sonarlint-intellij-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;

      - uses: actions/checkout@v5

      - uses: jdx/mise-action@v2.4.4
        with:
          version: 2025.9.12

      - name: Prepare IDE cache directory
        run: |
          sudo mkdir -p ${{ env.IDE_CACHE_DIR }}
          sudo chown -R $USER:$USER ${{ env.IDE_CACHE_DIR }}

      - name: Cache IntelliJ IDEA Community
        id: cache-intellij
        uses: SonarSource/ci-github-actions/cache@v1
        with:
          path: ${{ env.IDE_CACHE_DIR }}/intellij
          key: ${{ runner.os }}-intellij-${{ env.INTELLIJ_VERSION }}
          restore-keys: |
            ${{ runner.os }}-intellij-

      - name: Cache CLion
        id: cache-clion
        uses: SonarSource/ci-github-actions/cache@v1
        with:
          path: ${{ env.IDE_CACHE_DIR }}/clion
          key: ${{ runner.os }}-clion-${{ env.CLION_VERSION }}
          restore-keys: |
            ${{ runner.os }}-clion-

      - name: Cache Rider
        id: cache-rider
        uses: SonarSource/ci-github-actions/cache@v1
        with:
          path: ${{ env.IDE_CACHE_DIR }}/rider
          key: ${{ runner.os }}-rider-${{ env.RIDER_VERSION }}
          restore-keys: |
            ${{ runner.os }}-rider-

      - name: Cache CLion for ReSharper
        id: cache-resharper
        uses: SonarSource/ci-github-actions/cache@v1
        with:
          path: ${{ env.IDE_CACHE_DIR }}/resharper
          key: ${{ runner.os }}-resharper-${{ env.RESHARPER_VERSION }}
          restore-keys: |
            ${{ runner.os }}-resharper-

      - name: Cache IntelliJ IDEA Ultimate
        id: cache-ultimate
        uses: SonarSource/ci-github-actions/cache@v1
        with:
          path: ${{ env.IDE_CACHE_DIR }}/ultimate
          key: ${{ runner.os }}-ultimate-${{ env.ULTIMATE_VERSION }}
          restore-keys: |
            ${{ runner.os }}-ultimate-

      - name: Download IDEs from Repox (parallel, only missing ones)
        env:
          ARTIFACTORY_URL: https://repox.jfrog.io/artifactory
          ARTIFACTORY_USER: vault-SonarSource-sonarlint-intellij-private-reader
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          
          echo "Downloading missing IDEs from Repox in parallel..."
          PIDS=()
          
          # Download IntelliJ IDEA Community (if not cached)
          if [ "${{ steps.cache-intellij.outputs.cache-hit }}" != "true" ]; then
            (
              echo "Downloading IntelliJ IDEA Community ${INTELLIJ_VERSION} from Repox..."
              mkdir -p ${{ env.IDE_CACHE_DIR }}/intellij
              curl -fsSL -u "${ARTIFACTORY_USER}:${ARTIFACTORY_ACCESS_TOKEN}" \
                "${ARTIFACTORY_URL}/jetbrains-download/idea/ideaIC-${INTELLIJ_VERSION}.tar.gz" | \
                tar -xz --strip-components=1 -C ${{ env.IDE_CACHE_DIR }}/intellij
              echo "✓ IntelliJ IDEA Community done"
            ) &
            PIDS+=($!)
          else
            echo "✓ IntelliJ IDEA Community (cached)"
          fi
          
          # Download CLion (if not cached)
          if [ "${{ steps.cache-clion.outputs.cache-hit }}" != "true" ]; then
            (
              echo "Downloading CLion ${CLION_VERSION} from Repox..."
              mkdir -p ${{ env.IDE_CACHE_DIR }}/clion
              curl -fsSL -u "${ARTIFACTORY_USER}:${ARTIFACTORY_ACCESS_TOKEN}" \
                "${ARTIFACTORY_URL}/jetbrains-download/cpp/CLion-${CLION_VERSION}.tar.gz" | \
                tar -xz --strip-components=1 -C ${{ env.IDE_CACHE_DIR }}/clion
              echo "✓ CLion done"
            ) &
            PIDS+=($!)
          else
            echo "✓ CLion (cached)"
          fi
          
          # Download Rider (if not cached)
          if [ "${{ steps.cache-rider.outputs.cache-hit }}" != "true" ]; then
            (
              echo "Downloading Rider ${RIDER_VERSION} from Repox..."
              mkdir -p ${{ env.IDE_CACHE_DIR }}/rider
              curl -fsSL -u "${ARTIFACTORY_USER}:${ARTIFACTORY_ACCESS_TOKEN}" \
                "${ARTIFACTORY_URL}/jetbrains-download/rider/JetBrains.Rider-${RIDER_VERSION}.tar.gz" | \
                tar -xz --strip-components=1 -C ${{ env.IDE_CACHE_DIR }}/rider
              echo "✓ Rider done"
            ) &
            PIDS+=($!)
          else
            echo "✓ Rider (cached)"
          fi
          
          # Download CLion for ReSharper (if not cached)
          if [ "${{ steps.cache-resharper.outputs.cache-hit }}" != "true" ]; then
            (
              echo "Downloading CLion ${RESHARPER_VERSION} (for ReSharper) from Repox..."
              mkdir -p ${{ env.IDE_CACHE_DIR }}/resharper
              curl -fsSL -u "${ARTIFACTORY_USER}:${ARTIFACTORY_ACCESS_TOKEN}" \
                "${ARTIFACTORY_URL}/jetbrains-download/cpp/CLion-${RESHARPER_VERSION}.tar.gz" | \
                tar -xz --strip-components=1 -C ${{ env.IDE_CACHE_DIR }}/resharper
              echo "✓ CLion (ReSharper) done"
            ) &
            PIDS+=($!)
          else
            echo "✓ CLion (ReSharper) (cached)"
          fi
          
          # Download IntelliJ IDEA Ultimate (if not cached)
          if [ "${{ steps.cache-ultimate.outputs.cache-hit }}" != "true" ]; then
            (
              echo "Downloading IntelliJ IDEA Ultimate ${ULTIMATE_VERSION} from Repox..."
              mkdir -p ${{ env.IDE_CACHE_DIR }}/ultimate
              curl -fsSL -u "${ARTIFACTORY_USER}:${ARTIFACTORY_ACCESS_TOKEN}" \
                "${ARTIFACTORY_URL}/jetbrains-download/idea/ideaIU-${ULTIMATE_VERSION}.tar.gz" | \
                tar -xz --strip-components=1 -C ${{ env.IDE_CACHE_DIR }}/ultimate
              echo "✓ IntelliJ IDEA Ultimate done"
            ) &
            PIDS+=($!)
          else
            echo "✓ IntelliJ IDEA Ultimate (cached)"
          fi
          
          # Wait for all downloads to complete
          FAILED=0
          for pid in "${PIDS[@]}"; do
            wait "$pid" || FAILED=1
          done
          
          if [ $FAILED -eq 1 ]; then
            echo "One or more IDE downloads failed!"
            exit 1
          fi
          
          echo "All required IDEs ready"
          ls -la ${{ env.IDE_CACHE_DIR }}/

      - name: Set IDE environment variables
        run: |
          echo "IDEA_HOME=${{ env.IDE_CACHE_DIR }}/intellij" >> $GITHUB_ENV
          echo "CLION_HOME=${{ env.IDE_CACHE_DIR }}/clion" >> $GITHUB_ENV
          echo "RIDER_HOME=${{ env.IDE_CACHE_DIR }}/rider" >> $GITHUB_ENV
          echo "RESHARPER_HOME=${{ env.IDE_CACHE_DIR }}/resharper" >> $GITHUB_ENV
          echo "ULTIMATE_HOME=${{ env.IDE_CACHE_DIR }}/ultimate" >> $GITHUB_ENV

      - uses: SonarSource/ci-github-actions/build-gradle@v1
        env:
          ARTIFACTORY_ACCESS_USERNAME: vault-SonarSource-sonarlint-intellij-private-reader
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        with:
          run-shadow-scans: true
          artifactory-reader-role: private-reader
          artifactory-deployer-role: qa-deployer
          gradle-args: -x :its:check -x :buildPlugin -x :cyclonedxBom check jacocoTestReport

      - name: Run IRIS Analysis
        uses: SonarSource/unified-dogfooding-actions/run-iris@v1
        with:
          primary_project_key: "org.sonarsource.sonarlint.intellij:sonarlint-intellij"
          primary_platform: "Next"
          shadow1_project_key: "org.sonarsource.sonarlint.intellij:sonarlint-intellij"
          shadow1_platform: "SQC-EU"
          shadow2_project_key: "org.sonarsource.sonarlint.intellij:sonarlint-intellij"
          shadow2_platform: "SQC-US"
