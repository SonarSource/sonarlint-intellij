name: Build
on:
  push:
    branches:
      - master
      - branch-*
      - dogfood-*
  pull_request:
  workflow_dispatch:

concurrency:
  group: >-
    ${{ github.workflow }}-
    ${{ github.event.pull_request.base.ref || 'push' }}-
    ${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: write
  checks: write

env:
  # IDE installation paths for Linux
  IDE_CACHE_DIR: /opt/jetbrains

  # Base IDE versions for build and test
  INTELLIJ_VERSION: "2023.1.7"
  CLION_VERSION: "2023.1.7"
  RIDER_VERSION: "2023.1.7"
  RESHARPER_VERSION: "2024.1"
  ULTIMATE_VERSION: "2023.1.7"

jobs:
  build-number:
    outputs:
      BUILD_NUMBER: ${{ steps.build-number.outputs.BUILD_NUMBER }}
    runs-on: github-ubuntu-latest-m
    name: Get build number
    permissions:
      id-token: write
    steps:
      - uses: SonarSource/ci-github-actions/get-build-number@v1
        id: build-number

  aws-auth:
    runs-on: github-ubuntu-latest-m
    permissions:
      id-token: write
    outputs:
      # Note: Output key names are generated by aws-actions/amazon-ecr-login and include the registry URL (with account ID).
      # These cannot be templated due to GitHub Actions limitations.
      docker_username: ${{ steps.login-ecr.outputs.docker_username_275878209202_dkr_ecr_eu_central_1_amazonaws_com }}
      docker_password: ${{ steps.login-ecr.outputs.docker_password_275878209202_dkr_ecr_eu_central_1_amazonaws_com }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          aws-region: eu-central-1
          role-to-assume: arn:aws:iam::275878209202:role/deploymentroles/DevInfraSquadDockerImagesAccessRole

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1
        with:
          mask-password: 'false'

  build-plugin:
    runs-on: github-ubuntu-latest-m
    container:
      image: 275878209202.dkr.ecr.eu-central-1.amazonaws.com/sonarlint-intellij:20260219180730
      options: --user runner
      credentials:
        username: ${{ needs.aws-auth.outputs.docker_username }}
        password: ${{ needs.aws-auth.outputs.docker_password }}
    defaults:
      run:
        shell: bash
    needs:
      - build-number
      - aws-auth
    name: Build Plugin
    outputs:
      PROJECT_VERSION: ${{ steps.set_version.outputs.project-version }}
    env:
      BUILD_NUMBER: ${{ needs.build-number.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.9.12

      - name: Build Plugin
        env:
          IDEA_HOME: ${{ env.IDEA_2023_DIR }}
          CLION_HOME: ${{ env.CLION_2023_DIR }}
          RIDER_HOME: ${{ env.RIDER_2024_DIR }}
          RESHARPER_HOME: ${{ env.CLION_2024_DIR }}
          ULTIMATE_HOME: ${{ env.IDEA_ULTIMATE_2023_DIR }}
        uses: SonarSource/ci-github-actions/build-gradle@v1
        id: build_plugin
        with:
          sonar-platform: none
          deploy-pull-request: true
          use-develocity: true
          develocity-url: https://develocity-public.sonar.build
          artifactory-reader-role: private-reader
          artifactory-deployer-role: qa-deployer
          gradle-args: -x test -x :its:check :buildPlugin :cyclonedxBom

      - name: Set project version output
        id: set_version
        run: echo "project-version=${PROJECT_VERSION}" >> $GITHUB_OUTPUT

  check_windows:
    runs-on: warp-custom-sonarlint-intellij
    needs: build-number
    name: Test Windows
    env:
      BUILD_NUMBER: ${{ needs.build-number.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.9.12

      - name: Fetch vault secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/kv/data/repox url | ARTIFACTORY_URL;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;

      - name: Run checks
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          IDEA_HOME: C:\Program Files\intellij
          RIDER_HOME: C:\Program Files\rider
          RESHARPER_HOME: C:\Program Files\resharper
          CLION_HOME: C:\Program Files\clion
          ULTIMATE_HOME: C:\Program Files\ultimate
        run: .\gradlew.bat :check

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@3585e9575db828022551b4231f165eb59a0e74e3 # v5.6.2
        if: ${{ !cancelled() }}
        with:
          report_paths: '**/test-results/**/*.xml'

      - name: Upload test reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: test-reports-windows
          path: "**/reports/**/**"

      - name: Upload JUnit test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: junit-results-windows
          path: "**/test-results/**/*.xml"

  test-and-sonar:
    runs-on: github-ubuntu-latest-m
    container:
      image: 275878209202.dkr.ecr.eu-central-1.amazonaws.com/sonarlint-intellij:20260219180730
      options: --user runner
      credentials:
        username: ${{ needs.aws-auth.outputs.docker_username }}
        password: ${{ needs.aws-auth.outputs.docker_password }}
    defaults:
      run:
        shell: bash
    name: Tests and Sonar
    needs:
      - build-plugin
      - build-number
      - aws-auth
    env:
      BUILD_NUMBER: ${{ needs.build-number.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0  # Full history needed for Sonar blame

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.9.12

      - name: Run Tests and Sonar Analysis
        env:
          IDEA_HOME: ${{ env.IDEA_2023_DIR }}
          CLION_HOME: ${{ env.CLION_2023_DIR }}
          RIDER_HOME: ${{ env.RIDER_2024_DIR }}
          RESHARPER_HOME: ${{ env.CLION_2024_DIR }}
          ULTIMATE_HOME: ${{ env.IDEA_ULTIMATE_2023_DIR }}
        uses: SonarSource/ci-github-actions/build-gradle@v1
        with:
          deploy: false
          use-develocity: true
          develocity-url: https://develocity-public.sonar.build
          artifactory-reader-role: private-reader
          gradle-args: -x :its:check -x :buildPlugin -x :cyclonedxBom check jacocoTestReport

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@3585e9575db828022551b4231f165eb59a0e74e3 # v5.6.2
        if: ${{ !cancelled() }}
        with:
          report_paths: '**/test-results/**/*.xml'

      - name: Upload test reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: test-reports-linux
          path: "**/reports/**/**"

      - name: Upload JUnit test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: junit-results-linux
          path: "**/test-results/**/*.xml"

  verify-plugin:
    runs-on: github-ubuntu-latest-m
    container:
      image: 275878209202.dkr.ecr.eu-central-1.amazonaws.com/sonarlint-intellij:20260219180730
      options: --user runner
      credentials:
        username: ${{ needs.aws-auth.outputs.docker_username }}
        password: ${{ needs.aws-auth.outputs.docker_password }}
    defaults:
      run:
        shell: bash
    name: Verify Plugin
    needs:
      - build-plugin
      - build-number
      - aws-auth
    env:
      BUILD_NUMBER: ${{ needs.build-number.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.9.12

      - name: Verify Plugin Compatibility
        env:
          IDEA_HOME: ${{ env.IDEA_2023_DIR }}
          CLION_HOME: ${{ env.CLION_2023_DIR }}
          RIDER_HOME: ${{ env.RIDER_2024_DIR }}
          RESHARPER_HOME: ${{ env.CLION_2024_DIR }}
          ULTIMATE_HOME: ${{ env.IDEA_ULTIMATE_2023_DIR }}
        uses: SonarSource/ci-github-actions/build-gradle@v1
        with:
          deploy: false
          sonar-platform: none
          use-develocity: true
          develocity-url: https://develocity-public.sonar.build
          artifactory-reader-role: private-reader
          gradle-args: -x test -x check -x :its:check :verifyPlugin -PverifierEnv=CI

  qa:
    runs-on: github-ubuntu-latest-m
    container:
      image: 275878209202.dkr.ecr.eu-central-1.amazonaws.com/sonarlint-intellij:20260219180730
      options: --user runner
      credentials:
        username: ${{ needs.aws-auth.outputs.docker_username }}
        password: ${{ needs.aws-auth.outputs.docker_password }}
    defaults:
      run:
        shell: bash
    name: Run ITs - ${{ matrix.ide_version }} - ${{ matrix.test_suite || matrix.qa_category }}
    needs:
      - build-plugin
      - build-number
      - aws-auth
    strategy:
      fail-fast: false
      matrix:
        include:
          - ide_version: 'IC-2023.1.7'
            qa_category: 'Idea2023'
            test_suite: 'OpenInIdeTests'
          - ide_version: 'IC-2023.1.7'
            qa_category: 'Idea2023'
            test_suite: 'ConnectedAnalysisTests'
          - ide_version: 'IC-2023.1.7'
            qa_category: 'Idea2023'
            test_suite: 'ConfigurationTests'
          - ide_version: 'IC-2023.1.7'
            qa_category: 'Idea2023'
            test_suite: 'Standalone'
          - ide_version: 'IC-2025.3.2'
            qa_category: 'Idea2025'
            test_suite: 'OpenInIdeTests'
          - ide_version: 'IC-2025.3.2'
            qa_category: 'Idea2025'
            test_suite: 'ConnectedAnalysisTests'
          - ide_version: 'IC-2025.3.2'
            qa_category: 'Idea2025'
            test_suite: 'ConfigurationTests'
          - ide_version: 'IC-2025.3.2'
            qa_category: 'Idea2025'
            test_suite: 'Standalone'
          - ide_version: 'IU-2023.1.7'
            qa_category: 'IdeaUltimate2023'
          #          - ide_version: 'IU-2025.3.2'
          #            qa_category: 'IdeaUltimate2025'
          - ide_version: 'PY-2023.3.7'
            qa_category: 'PyCharmProfessional2023'
          #          - ide_version: 'PY-2025.3.2.1'
          #            qa_category: 'PyCharmProfessional2025'
          - ide_version: 'PC-2023.3.7'
            qa_category: 'PyCharmCommunity2023'
          #          - ide_version: 'PC-2025.3.2.1'
          #            qa_category: 'PyCharmCommunity2025'
          #          - ide_version: 'RD-2023.1.7'
          #            qa_category: 'Rider2023'
          #          - ide_version: 'RD-2024.3.9'
          #            qa_category: 'Rider2024'
          # Temporarily disabled, consistently failing
          #          - ide_version: 'RD-2025.1.5'
          #            qa_category: 'Rider2025'
          - ide_version: 'PS-2023.3.8'
            qa_category: 'PhpStorm2023'
          - ide_version: 'PS-2025.3.2'
            qa_category: 'PhpStorm2025'
          - ide_version: 'GO-2023.3.8'
            qa_category: 'GoLand2023'
          - ide_version: 'GO-2025.3.2'
            qa_category: 'GoLand2025'
          - ide_version: 'CL-2023.1.7'
            qa_category: 'CLion2023'
          - ide_version: 'CL-2025.3.2'
            qa_category: 'CLion2025'
    env:
      DISPLAY: ':10'
      JDK_VERSION: '21'
      IDEA_VERSION: ${{ matrix.ide_version }}
      QA_CATEGORY: ${{ matrix.qa_category }}
      TEST_SUITE: ${{ matrix.test_suite }}
      BUILD_NUMBER: ${{ needs.build-number.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.9.12

      - name: Select Java ${{ env.JDK_VERSION }}
        run: mise use java@${{ env.JDK_VERSION }}

      - name: Vault Secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/kv/data/repox url | ARTIFACTORY_URL;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/team/sonarlint/kv/data/ide.keys clion | CLION_KEY;
            development/team/sonarlint/kv/data/ide.keys goland | GOLAND_KEY;
            development/team/sonarlint/kv/data/ide.keys idea | IDEA_KEY;
            development/team/sonarlint/kv/data/ide.keys phpstorm | PHPSTORM_KEY;
            development/team/sonarlint/kv/data/ide.keys pycharm | PYCHARM_KEY;
            development/team/sonarlint/kv/data/ide.keys rider | RIDER_KEY;
            development/github/token/licenses-ro token | GITHUB_TOKEN;
            development/team/sonarlint/kv/data/sonarcloud-it token | SONARCLOUD_IT_TOKEN;
            development/kv/data/develocity token | DEVELOCITY_TOKEN;

      - name: Compute month key
        id: month
        run: |
          THIS_MONTH="$(date +%Y-%m)"
          echo "month=${THIS_MONTH}" >> "$GITHUB_OUTPUT"
          ORCHESTRATOR_HOME="${GITHUB_WORKSPACE}/orchestrator/${THIS_MONTH}"
          echo "ORCHESTRATOR_HOME=${ORCHESTRATOR_HOME}" >> "$GITHUB_ENV"
          echo "Create dir ${ORCHESTRATOR_HOME}"
          mkdir -p "${ORCHESTRATOR_HOME}"

      - uses: SonarSource/gh-action_cache@v1
        with:
          path: ${{ github.workspace }}/orchestrator/${{ steps.month.outputs.month }}
          key: cache-${{ runner.os }}-${{ steps.month.outputs.month }}
          restore-keys: |
            cache-${{ runner.os }}

      - name: Generate Gradle Cache Key
        id: gradle-cache-key
        run: |
          /usr/bin/find . \( -name '*.gradle' -o -name '*.gradle.kts' \) -type f -exec md5sum {} \; | sort > gradle-md5-sums.txt
          md5sum gradle/libs.versions.toml gradle/wrapper/gradle-wrapper.properties 2>/dev/null >> gradle-md5-sums.txt || true
          GRADLE_CACHE_KEY=$(md5sum gradle-md5-sums.txt | awk '{ print $1 }')
          echo "key=${GRADLE_CACHE_KEY}" >> "$GITHUB_OUTPUT"
          rm -f gradle-md5-sums.txt

      - name: Restore Gradle Cache
        uses: SonarSource/gh-action_cache@v1
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ github.workflow }}-${{ steps.gradle-cache-key.outputs.key }}
          restore-keys: |
            gradle-${{ runner.os }}-${{ github.workflow }}-

      - name: Start Xvfb
        run: |
          Xvfb ${DISPLAY} -screen 0 1280x960x24 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          sleep 2

      - name: Determine IDE source (embedded vs Repox)
        id: ide-source
        run: |
          IDE="${{ matrix.ide_version }}"
          # Parse IDE code and version
          IDE_CODE="${IDE%%-*}"
          IDE_VERSION="${IDE#*-}"
          IDE_YEAR="${IDE_VERSION%%.*}"

          # Check if embedded in container
          EMBEDDED="false"
          CACHE_PATH=""

          case "$IDE_CODE-$IDE_YEAR" in
            IC-2023|IU-2023|CL-2023|CL-2024|RD-2023|RD-2024)
              EMBEDDED="true"
              ;;
            *)
              EMBEDDED="false"
              # Determine cache path based on IDE code
              case "$IDE_CODE" in
                IC) CACHE_PATH="$HOME/.cache/JetBrains/IdeaIC/$IDE_VERSION" ;;
                IU) CACHE_PATH="$HOME/.cache/JetBrains/IdeaIU/$IDE_VERSION" ;;
                CL) CACHE_PATH="$HOME/.cache/JetBrains/CLion/$IDE_VERSION" ;;
                RD) CACHE_PATH="$HOME/.cache/JetBrains/Rider/$IDE_VERSION" ;;
                PY) CACHE_PATH="$HOME/.cache/JetBrains/PyCharm/$IDE_VERSION" ;;
                PC) CACHE_PATH="$HOME/.cache/JetBrains/PyCharmCE/$IDE_VERSION" ;;
                PS) CACHE_PATH="$HOME/.cache/JetBrains/PhpStorm/$IDE_VERSION" ;;
                GO) CACHE_PATH="$HOME/.cache/JetBrains/GoLand/$IDE_VERSION" ;;
              esac
              ;;
          esac

          echo "embedded=$EMBEDDED" >> $GITHUB_OUTPUT
          echo "cache_path=$CACHE_PATH" >> $GITHUB_OUTPUT
          echo "IDE: $IDE (code=$IDE_CODE, version=$IDE_VERSION, year=$IDE_YEAR)"
          echo "Embedded: $EMBEDDED"
          echo "Cache path: $CACHE_PATH"

      - name: Restore IDE from cache
        if: steps.ide-source.outputs.embedded == 'false'
        id: cache-ide
        uses: SonarSource/gh-action_cache@v1
        with:
          path: ${{ steps.ide-source.outputs.cache_path }}
          key: ${{ runner.os }}-jetbrains-ide-${{ matrix.ide_version }}
          restore-keys: |
            ${{ runner.os }}-jetbrains-ide-${{ matrix.ide_version }}-

      - name: Setup IDE for QA test
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_USER: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          CACHE_HIT: ${{ steps.cache-ide.outputs.cache-hit }}
        run: .github/scripts/setup-qa-ide.sh "${{ matrix.ide_version }}"

      - name: Validate IDE setup for ${{ matrix.ide_version }}
        run: |
          # Determine expected environment variable
          IDE_CODE="${IDEA_VERSION%%-*}"
          case "$IDE_CODE" in
            IC|IU) IDE_VAR="IDEA_HOME" ;;
            CL) IDE_VAR="CLION_HOME" ;;
            RD) IDE_VAR="RIDER_HOME" ;;
            PY|PC) IDE_VAR="PYCHARM_HOME" ;;
            PS) IDE_VAR="PHPSTORM_HOME" ;;
            GO) IDE_VAR="GOLAND_HOME" ;;
            *) echo "::error::Unknown IDE code: $IDE_CODE"; exit 1 ;;
          esac
          if [ -z "${!IDE_VAR:-}" ]; then
            echo "::error::${IDE_VAR} is not defined or is empty"
            exit 1
          fi
          IDE_PATH="${!IDE_VAR}"
          echo "Found ${IDE_VAR}=${IDE_PATH}"
          if [ ! -d "${IDE_PATH}" ]; then
            echo "::error::IDE path does not exist: ${IDE_PATH}"
            exit 1
          fi
          if [ -z "$(ls -A "${IDE_PATH}" 2>/dev/null)" ]; then
            echo "::error::IDE path is empty: ${IDE_PATH}"
            exit 1
          fi

          echo "âœ“ IDE validation successful"
          echo "  Variable: ${IDE_VAR}"
          echo "  Path: ${IDE_PATH}"
          echo "  Contents sample:"
          ls -la "${IDE_PATH}" | head -10

      - name: Extract and setup plugin
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_PRIVATE_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          PROJECT_VERSION: ${{ needs.build-plugin.outputs.PROJECT_VERSION }}
        shell: bash --noprofile --norc -euo pipefail {0}
        run: |
          echo "Using project version: ${PROJECT_VERSION}"
          curl -fsSL -u "${ARTIFACTORY_PRIVATE_USERNAME}:${ARTIFACTORY_PRIVATE_PASSWORD}" \
            -o sonarlint-intellij.zip \
            "${ARTIFACTORY_URL}/sonarsource-public-qa/org/sonarsource/sonarlint/intellij/sonarlint-intellij/${PROJECT_VERSION}/sonarlint-intellij-${PROJECT_VERSION}.zip"
          unzip sonarlint-intellij.zip -d ${GITHUB_WORKSPACE}/downloaded-plugin
          mv downloaded-plugin/sonarlint-intellij downloaded-plugin/staged-plugin
          rm sonarlint-intellij.zip
          
          mkdir -p its/build/idea-sandbox/${IDEA_VERSION}/config_runIdeForUiTests/
          
          # Decode license keys
          echo "${{ fromJSON(steps.secrets.outputs.vault).CLION_KEY }}" | base64 -d > its/build/idea-sandbox/${IDEA_VERSION}/config_runIdeForUiTests/clion.key
          echo "${{ fromJSON(steps.secrets.outputs.vault).GOLAND_KEY }}" | base64 -d > its/build/idea-sandbox/${IDEA_VERSION}/config_runIdeForUiTests/goland.key
          echo "${{ fromJSON(steps.secrets.outputs.vault).IDEA_KEY }}" | base64 -d > its/build/idea-sandbox/${IDEA_VERSION}/config_runIdeForUiTests/idea.key
          echo "${{ fromJSON(steps.secrets.outputs.vault).PHPSTORM_KEY }}" | base64 -d > its/build/idea-sandbox/${IDEA_VERSION}/config_runIdeForUiTests/phpstorm.key
          echo "${{ fromJSON(steps.secrets.outputs.vault).PYCHARM_KEY }}" | base64 -d > its/build/idea-sandbox/${IDEA_VERSION}/config_runIdeForUiTests/pycharm.key
          echo "${{ fromJSON(steps.secrets.outputs.vault).RIDER_KEY }}" | base64 -d > its/build/idea-sandbox/${IDEA_VERSION}/config_runIdeForUiTests/rider.key
          
          # Start metacity
          metacity --sm-disable --replace &
          sleep 3

      - name: Start IDE in background
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          # Start IDE in background using Gradle
          nohup gradle :its:runIdeForUiTests --stacktrace -i \
            -PijVersion=${IDEA_VERSION} \
            -PslPluginDirectory=${GITHUB_WORKSPACE}/downloaded-plugin > ${GITHUB_WORKSPACE}/runIdeGradle.log 2>&1 &
          echo "IDE_PID=$!" >> $GITHUB_ENV

      - name: Wait for IDE to start
        run: |
          echo "Waiting for IDE to start..."
          # retry every 5 seconds, max 150 times (750 seconds total)
          curl --retry 150 \
               --retry-delay 5 \
               --retry-all-errors \
               --fail \
               --max-time 3 \
               --connect-timeout 2 \
               --silent \
               --output /dev/null \
               http://127.0.0.1:8082 2>/dev/null && echo "IDE is ready!" || (echo "Timeout waiting for IDE to start" && exit 1)

      - name: Start recording
        run: |
          echo 'Recording tests on video'
          ffmpeg -loglevel warning -f x11grab -video_size 1280x960 -i ${DISPLAY} \
            -codec:v libx264 -r 12 ${GITHUB_WORKSPACE}/recording_${IDEA_VERSION}.mp4 &
          echo "FFMPEG_PID=$!" >> $GITHUB_ENV

      - name: Run integration tests
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_ACCESS_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          SONARCLOUD_IT_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).SONARCLOUD_IT_TOKEN }}
          GITHUB_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).GITHUB_TOKEN }}
          DEVELOCITY_TOKEN: ${{ fromJSON(steps.secrets.outputs.vault).DEVELOCITY_TOKEN }}
          DEVELOCITY_ACCESS_KEY: develocity-public.sonar.build=${{ fromJSON(steps.secrets.outputs.vault).DEVELOCITY_TOKEN }}
        run: ./gradlew :its:check --stacktrace -i -PijVersion=${IDEA_VERSION} -PslPluginDirectory=${GITHUB_WORKSPACE}/downloaded-plugin --dependency-verification lenient --rerun-tasks

      - name: Stop recording
        if: always()
        run: |
          if [ -n "$FFMPEG_PID" ] && kill -0 $FFMPEG_PID 2>/dev/null; then
            kill -2 $FFMPEG_PID
            # Wait for ffmpeg to finish
            timeout=30
            while kill -0 $FFMPEG_PID 2>/dev/null && [ $timeout -gt 0 ]; do
              sleep 1
              timeout=$((timeout - 1))
            done
          fi
          if [ -n "$XVFB_PID" ] && kill -0 $XVFB_PID 2>/dev/null; then
            kill $XVFB_PID
          fi

      - name: Display IDE log
        if: always()
        run: |
          if [ -f ${GITHUB_WORKSPACE}/runIdeGradle.log ]; then
            cat ${GITHUB_WORKSPACE}/runIdeGradle.log
          fi

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@3585e9575db828022551b4231f165eb59a0e74e3 # v5.6.2
        if: ${{ !cancelled() }}
        with:
          report_paths: '**/test-results/**/*.xml'

      - name: Upload test recording
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: test-recording-${{ matrix.ide_version }}-${{ matrix.test_suite || matrix.qa_category }}
          path: ${{ github.workspace }}/recording_${{ matrix.ide_version }}.mp4
          if-no-files-found: warn

      - name: Upload test reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: test-reports-qa-${{ matrix.ide_version }}-${{ matrix.test_suite || matrix.qa_category }}
          path: "**/reports/**/*"
          if-no-files-found: warn

      - name: Upload JUnit test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: junit-results-qa-${{ matrix.ide_version }}-${{ matrix.test_suite || matrix.qa_category }}
          path: "**/test-results/**/*.xml"

  promote:
    runs-on: github-ubuntu-latest-m
    name: Promote
    needs:
      - build-number
      - build-plugin
      - test-and-sonar
      - check_windows
      - qa
    if: ${{ github.event_name == 'pull_request' || github.ref_name == github.event.repository.default_branch || startsWith(github.ref_name, 'branch-') || startsWith(github.ref_name, 'dogfood-on-') }}
    env:
      BUILD_NUMBER: ${{ needs.build-number.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.9.12

      - name: Promote artifacts
        uses: SonarSource/ci-github-actions/promote@v1
        env:
          PROJECT_VERSION: ${{ needs.build-plugin.outputs.PROJECT_VERSION }}
        with:
          promote-pull-request: true

  dogfood:
    runs-on: github-ubuntu-latest-m
    name: Update Dogfood Repository
    needs:
      - build-number
      - build-plugin
      - promote
    if: ${{ github.ref_name == github.event.repository.default_branch }}
    env:
      BUILD_NUMBER: ${{ needs.build-number.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.9.12
          experimental: true

      - name: Fetch vault secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/kv/data/repox url | ARTIFACTORY_URL;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-promoter access_token | ARTIFACTORY_API_KEY;

      - name: Update dogfood repository
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_API_KEY: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_API_KEY }}
          PROJECT_VERSION: ${{ needs.build-plugin.outputs.PROJECT_VERSION }}
        run: |
          cat > updatePlugins.xml << EOF
          <plugins>
            <plugin id="org.sonarlint.idea" url="${ARTIFACTORY_URL}/sonarsource/org/sonarsource/sonarlint/intellij/sonarlint-intellij/${PROJECT_VERSION}/sonarlint-intellij-${PROJECT_VERSION}.zip" version="${PROJECT_VERSION}"/>
          </plugins>
          EOF
          cat updatePlugins.xml
          
          # Upload to Artifactory using jfrog CLI
          jf rt u updatePlugins.xml \
            sonarsource-public-builds/org/sonarsource/sonarlint/intellij/sonarlint-intellij/ \
            --url "${ARTIFACTORY_URL}" \
            --access-token "${ARTIFACTORY_API_KEY}" \
            --build-name "${{ github.event.repository.name }}" \
            --build-number "$BUILD_NUMBER"
